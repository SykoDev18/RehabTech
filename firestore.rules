rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============ FUNCIONES AUXILIARES ============
    
    // Verificar si el usuario está autenticado
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Verificar si es el propietario del documento
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Obtener datos del usuario actual
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }
    
    // Verificar si el usuario es terapeuta
    function isTherapist() {
      return isAuthenticated() && getUserData().userType == 'therapist';
    }
    
    // Verificar si el usuario es paciente
    function isPatient() {
      return isAuthenticated() && getUserData().userType == 'patient';
    }
    
    // Verificar si el terapeuta tiene asignado al paciente
    function isAssignedTherapist(patientId) {
      let patientData = get(/databases/$(database)/documents/users/$(patientId)).data;
      return isTherapist() && patientData.therapistId == request.auth.uid;
    }

    // Validar que solo se actualicen campos permitidos
    function onlyUpdatesFields(allowedFields) {
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(allowedFields);
    }
    
    // ============ COLECCIÓN DE USUARIOS ============
    match /users/{userId} {
      // Lectura: el propio usuario O su terapeuta asignado O búsqueda por patientId
      allow read: if isOwner(userId) 
                  || isAssignedTherapist(userId)
                  || (isTherapist() && resource.data.therapistId == request.auth.uid);
      
      // Crear: solo el propio usuario (al registrarse)
      allow create: if isOwner(userId);
      
      // Actualizar: el propio usuario puede actualizar su perfil
      // O un terapeuta puede vincular/desvincular al paciente (actualizar therapistId)
      allow update: if isOwner(userId) 
                    || (isTherapist() && onlyUpdatesFields(['therapistId']));
      
      // Eliminar: solo el propio usuario
      allow delete: if isOwner(userId);
      
      // ============ SUBCOLECCIONES DEL USUARIO ============
      
      // Chats con Nora (solo el propietario)
      match /nora_chats/{chatId} {
        allow read, write: if isOwner(userId);
        
        match /messages/{messageId} {
          allow read, write: if isOwner(userId);
        }
      }
      
      // Contexto del paciente (propietario y su terapeuta)
      match /patient_context/{docId} {
        allow read, write: if isOwner(userId);
        allow read: if isAssignedTherapist(userId);
      }
      
      // Progreso de ejercicios (propietario y su terapeuta)
      match /progress/{progressId} {
        allow read, write: if isOwner(userId);
        allow read: if isAssignedTherapist(userId);
      }
      
      // Sesiones de terapia
      match /sessions/{sessionId} {
        allow read, write: if isOwner(userId);
        allow read: if isAssignedTherapist(userId);
      }
      
      // Rutinas asignadas al paciente (terapeuta puede escribir, paciente puede leer)
      match /routines/{routineId} {
        allow read: if isOwner(userId) || isAssignedTherapist(userId);
        allow write: if isAssignedTherapist(userId);
        
        match /exercises/{exerciseId} {
          allow read: if isOwner(userId) || isAssignedTherapist(userId);
          allow write: if isAssignedTherapist(userId);
        }
      }
    }
    
    // ============ COLECCIÓN DE PACIENTES (vista del terapeuta) ============
    match /therapists/{therapistId}/patients/{patientId} {
      allow read, write: if isOwner(therapistId);
    }
    
    // ============ COLECCIÓN DE RUTINAS ============
    match /routines/{routineId} {
      // El terapeuta que creó la rutina puede leer/escribir
      allow read, write: if isAuthenticated() && resource.data.therapistId == request.auth.uid;
      // El paciente asignado puede leer
      allow read: if isAuthenticated() && resource.data.patientId == request.auth.uid;
      // Crear nueva rutina si es terapeuta
      allow create: if isTherapist();
      
      match /exercises/{exerciseId} {
        allow read, write: if isAuthenticated() && 
          get(/databases/$(database)/documents/routines/$(routineId)).data.therapistId == request.auth.uid;
        allow read: if isAuthenticated() && 
          get(/databases/$(database)/documents/routines/$(routineId)).data.patientId == request.auth.uid;
      }
    }
    
    // ============ COLECCIÓN DE CITAS ============
    match /appointments/{appointmentId} {
      // El terapeuta o paciente involucrado pueden leer
      allow read: if isAuthenticated() && 
        (resource.data.therapistId == request.auth.uid || resource.data.patientId == request.auth.uid);
      // Solo el terapeuta puede crear/modificar/eliminar
      allow create: if isTherapist();
      allow update, delete: if isAuthenticated() && resource.data.therapistId == request.auth.uid;
    }
    
    // ============ COLECCIÓN DE CONVERSACIONES ============
    match /conversations/{conversationId} {
      // Ambos participantes pueden leer
      allow read: if isAuthenticated() && 
        (resource.data.therapistId == request.auth.uid || resource.data.patientId == request.auth.uid);
      // Crear conversación si es terapeuta o paciente vinculado
      allow create: if isAuthenticated();
      // Actualizar (para lastMessage, etc.)
      allow update: if isAuthenticated() && 
        (resource.data.therapistId == request.auth.uid || resource.data.patientId == request.auth.uid);
      
      match /messages/{messageId} {
        allow read, write: if isAuthenticated() && 
          (get(/databases/$(database)/documents/conversations/$(conversationId)).data.therapistId == request.auth.uid ||
           get(/databases/$(database)/documents/conversations/$(conversationId)).data.patientId == request.auth.uid);
      }
    }
    
    // ============ COLECCIÓN DE EJERCICIOS (catálogo global) ============
    match /exercises/{exerciseId} {
      allow read: if isAuthenticated();
      allow write: if isTherapist();
    }

    // ============ COLECCIÓN DE NOTIFICACIONES ============
    match /notifications/{notificationId} {
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated();
    }

    // ============ REPORTES/FEEDBACK ============
    match /feedback/{feedbackId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // ============ TOKENS FCM (para notificaciones push) ============
    match /fcm_tokens/{tokenId} {
      // Solo el propietario puede gestionar sus tokens
      allow read, write: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }

    // ============ CONFIGURACIÓN DE NOTIFICACIONES ============
    match /notification_settings/{userId} {
      allow read, write: if isOwner(userId);
    }

    // ============ HISTORIAL DE NOTIFICACIONES ENVIADAS ============
    match /sent_notifications/{notificationId} {
      // Solo lectura para el destinatario
      allow read: if isAuthenticated() && resource.data.recipientId == request.auth.uid;
      // Crear solo desde backend (Cloud Functions) - regla más permisiva para desarrollo
      allow create: if isAuthenticated();
      // Marcar como leída
      allow update: if isAuthenticated() 
                    && resource.data.recipientId == request.auth.uid
                    && onlyUpdatesFields(['read', 'readAt']);
    }

    // ============ STREAKS Y LOGROS ============
    match /user_streaks/{userId} {
      allow read: if isOwner(userId) || isAssignedTherapist(userId);
      allow write: if isOwner(userId);
    }

    match /achievements/{achievementId} {
      // Catálogo de logros - todos pueden leer
      allow read: if isAuthenticated();
      // Solo admin puede escribir (en producción, restringir más)
      allow write: if false;
    }

    match /user_achievements/{docId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if false; // Los logros no se modifican una vez otorgados
    }
  }
}
